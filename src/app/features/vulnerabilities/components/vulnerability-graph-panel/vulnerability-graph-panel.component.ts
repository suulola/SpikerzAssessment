import { ChangeDetectionStrategy, Component, computed, inject, signal } from '@angular/core';
import { CommonModule, DOCUMENT } from '@angular/common';
import { ChartModule } from 'primeng/chart';
import type { ChartData, ChartOptions } from 'chart.js';
import { GraphVisualizationComponent } from '../graph-visualization/graph-visualization.component';
import { GraphDomainStore } from '@core/state/graph-domain.store';

@Component({
  selector: 'app-vulnerability-graph-panel',
  standalone: true,
  imports: [CommonModule, ChartModule, GraphVisualizationComponent],
  templateUrl: './vulnerability-graph-panel.component.html',
  styleUrl: './vulnerability-graph-panel.component.scss',
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class VulnerabilityGraphPanelComponent {
  private readonly document = inject(DOCUMENT);
  private readonly graphDomainStore = inject(GraphDomainStore);
  private readonly riskColors = this.getRiskColors();
  readonly legendItems = this.graphDomainStore.legendItems;

  readonly assetRows = this.graphDomainStore.assetRiskRows;

  readonly pageSize = 2;
  readonly currentPage = signal(1);
  readonly totalPages = computed(() =>
    Math.max(1, Math.ceil(this.assetRows().length / this.pageSize))
  );
  readonly pagedAssets = computed(() => {
    const startIndex = (this.currentPage() - 1) * this.pageSize;
    return this.assetRows().slice(startIndex, startIndex + this.pageSize);
  });
  readonly canGoPrev = computed(() => this.currentPage() > 1);
  readonly canGoNext = computed(() => this.currentPage() < this.totalPages());

  readonly riskSummary = this.graphDomainStore.riskSummary;

  readonly riskTotal = computed(() =>
    this.riskSummary().reduce((total, item) => total + item.count, 0)
  );

  readonly riskChartData = computed<ChartData<'doughnut'>>(() => ({
    labels: this.riskSummary().map(item => item.label),
    datasets: [
      {
        data: this.riskSummary().map(item => item.count),
        backgroundColor: this.riskColors,
        borderWidth: 0
      }
    ]
  }));

  readonly riskChartOptions: ChartOptions<'doughnut'> = {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '70%',
    plugins: {
      legend: { display: false },
      tooltip: { enabled: false }
    },
    animation: {
      duration: 400
    }
  };

  get paginationLabel(): string {
    if (this.assetRows().length === 0) {
      return 'Showing 0 of 0';
    }

    const start = (this.currentPage() - 1) * this.pageSize + 1;
    const end = Math.min(this.assetRows().length, this.currentPage() * this.pageSize);
    return `Showing ${start}-${end} of ${this.assetRows().length}`;
  }

  prevPage(): void {
    if (this.canGoPrev()) {
      this.currentPage.update(page => page - 1);
    }
  }

  nextPage(): void {
    if (this.canGoNext()) {
      this.currentPage.update(page => page + 1);
    }
  }

  private getRiskColors(): string[] {
    const styles = getComputedStyle(this.document.documentElement);
    const readVar = (name: string) => styles.getPropertyValue(name).trim();
    return [
      readVar('--risk-critical'),
      readVar('--risk-high'),
      readVar('--risk-medium'),
      readVar('--risk-low')
    ];
  }
}
