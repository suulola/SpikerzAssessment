import { ChangeDetectionStrategy, Component, computed, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ChartModule } from 'primeng/chart';
import type { ChartData, ChartOptions } from 'chart.js';
import { GraphVisualizationComponent } from '../graph-visualization/graph-visualization.component';

@Component({
  selector: 'app-vulnerability-graph-panel',
  standalone: true,
  imports: [CommonModule, ChartModule, GraphVisualizationComponent],
  templateUrl: './vulnerability-graph-panel.component.html',
  styleUrl: './vulnerability-graph-panel.component.scss',
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class VulnerabilityGraphPanelComponent {
  readonly legendItems = [
    {
      label: 'Critical',
      icon: 'assets/icons/graph/legend-critical.svg',
      toneClass: 'graph-panel__legend-chip--critical'
    },
    {
      label: 'High',
      icon: 'assets/icons/graph/legend-high.svg',
      toneClass: 'graph-panel__legend-chip--warning'
    },
    {
      label: 'Low',
      icon: 'assets/icons/graph/legend-low.svg',
      toneClass: 'graph-panel__legend-chip--ok'
    }
  ];

  readonly assetRows = [
    {
      icon: 'assets/icons/graph/asset-server.svg',
      name: 'app-api-01',
      ip: '192.168.1.1',
      risk: 'Critical'
    },
    {
      icon: 'assets/icons/graph/asset-server.svg',
      name: 'app-api-02',
      ip: '192.168.1.2',
      risk: 'Critical'
    },
    {
      icon: 'assets/icons/graph/asset-server.svg',
      name: 'api-gateway-01',
      ip: '192.168.1.8',
      risk: 'High'
    },
    {
      icon: 'assets/icons/graph/asset-server.svg',
      name: 'billing-service-01',
      ip: '192.168.1.12',
      risk: 'Medium'
    },
    {
      icon: 'assets/icons/graph/asset-server.svg',
      name: 'analytics-worker-01',
      ip: '192.168.1.18',
      risk: 'Low'
    },
    {
      icon: 'assets/icons/graph/asset-server.svg',
      name: 'auth-proxy-01',
      ip: '192.168.1.21',
      risk: 'High'
    }
  ];

  readonly pageSize = 2;
  readonly currentPage = signal(1);
  readonly totalPages = computed(() => Math.max(1, Math.ceil(this.assetRows.length / this.pageSize)));
  readonly pagedAssets = computed(() => {
    const startIndex = (this.currentPage() - 1) * this.pageSize;
    return this.assetRows.slice(startIndex, startIndex + this.pageSize);
  });
  readonly canGoPrev = computed(() => this.currentPage() > 1);
  readonly canGoNext = computed(() => this.currentPage() < this.totalPages());

  readonly riskSummary = [
    {
      count: 2,
      label: 'Critical',
      toneClass: 'graph-panel__risk-item--critical'
    },
    {
      count: 2,
      label: 'High',
      toneClass: 'graph-panel__risk-item--high'
    },
    {
      count: 1,
      label: 'Medium',
      toneClass: 'graph-panel__risk-item--medium'
    },
    {
      count: 1,
      label: 'Low',
      toneClass: 'graph-panel__risk-item--low'
    }
  ];

  readonly riskTotal = computed(() =>
    this.riskSummary.reduce((total, item) => total + item.count, 0)
  );

  readonly riskChartData = computed<ChartData<'doughnut'>>(() => ({
    labels: this.riskSummary.map(item => item.label),
    datasets: [
      {
        data: this.riskSummary.map(item => item.count),
        backgroundColor: ['#C6190D', '#E5372B', '#EBA622', '#08B94E'],
        borderWidth: 0
      }
    ]
  }));

  readonly riskChartOptions: ChartOptions<'doughnut'> = {
    responsive: true,
    maintainAspectRatio: false,
    cutout: '70%',
    plugins: {
      legend: { display: false },
      tooltip: { enabled: false }
    },
    animation: {
      duration: 400
    }
  };

  get paginationLabel(): string {
    if (this.assetRows.length === 0) {
      return 'Showing 0 of 0';
    }

    const start = (this.currentPage() - 1) * this.pageSize + 1;
    const end = Math.min(this.assetRows.length, this.currentPage() * this.pageSize);
    return `Showing ${start}-${end} of ${this.assetRows.length}`;
  }

  prevPage(): void {
    if (this.canGoPrev()) {
      this.currentPage.update(page => page - 1);
    }
  }

  nextPage(): void {
    if (this.canGoNext()) {
      this.currentPage.update(page => page + 1);
    }
  }

}
